<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
    <title>ITãƒ‘ã‚¹ãƒãƒ¼ãƒˆ</title>
    <style>
        /* ã”æç¤ºã®ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’ãƒ™ãƒ¼ã‚¹ã«èª¿æ•´ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; padding: 0.5rem; background: #f9f9f9; color: #333; font-size: 18px; line-height: 1.6;
        }
        .container { max-width: 600px; margin: 0 auto; padding-bottom: 100px; }
        h1 { text-align: center; font-size: 1.8rem; margin: 0.5rem 0 1rem; cursor: pointer; }
        .tag-btn, .action-btn {
            display: block; width: 100%; padding: 1rem; margin: 0.5rem 0;
            border: 1px solid #ccc; border-radius: 6px; font-size: 1.1rem;
            background: #fff; text-align: center; cursor: pointer;
        }
        .tag-btn:active { background: #f0f0f0; }
        .meta { font-size: 0.8rem; color: #888; text-align: center; margin-bottom: 0.5rem; }
        #question, #v-name { margin: 0.8rem 0; font-size: 1.2rem; font-weight: bold; line-height: 1.6; text-align: center; }
        .options-list { list-style: none; padding: 0; margin: 0; }
        .options-list li { margin-bottom: 0.6rem; }
        .options-list button {
            width: 100%; padding: 1.1rem; font-size: 1.1rem; border: 1px solid #ccc;
            border-radius: 6px; background: #fff; text-align: left; cursor: pointer;
        }
        .options-list button:disabled { opacity: 0.7; }
        
        /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ»ãƒ¢ãƒ¼ãƒ€ãƒ« */
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); display: none;
            z-index: 100; align-items: center; justify-content: center;
        }
        #modal {
            background: #fff; padding: 1.5rem; border-radius: 8px;
            width: 85%; max-width: 400px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        #modal-explanation {
            font-size: 0.95rem; color: #333; margin-top: 1rem;
            border-top: 1px solid #eee; padding-top: 1rem;
        }
        #modalNextBtn {
            display: block; width: 100%; padding: 1rem; margin-top: 1.5rem;
            border: none; border-radius: 6px; font-size: 1.1rem;
            background: #0078d7; color: #fff; cursor: pointer;
        }

        /* ãƒ•ãƒƒã‚¿ãƒ¼ãƒ„ãƒ¼ãƒ«ï¼ˆå³ä¸‹ãƒªã‚»ãƒƒãƒˆï¼‰ */
        .footer-tools { position: fixed; right: 20px; bottom: 60px; z-index: 50; }
        .reset-link { font-size: 0.75rem; color: #ccc; border: none; background: none; text-decoration: underline; cursor: pointer; }
        
        .screen { display: none; }
        .active { display: block; }
    </style>
</head>
<body>

<div class="container">
    <h1 id="mainTitle" onclick="location.reload()">ITãƒ‘ã‚¹ãƒãƒ¼ãƒˆ</h1>

    <div id="home" class="screen active">
        <div id="controls">
            <button class="tag-btn" onclick="startQuiz('ã‚¹ãƒˆãƒ©ãƒ†ã‚¸')">ã‚¹ãƒˆãƒ©ãƒ†ã‚¸ç³»</button>
            <button class="tag-btn" onclick="startQuiz('ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆ')">ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆç³»</button>
            <button class="tag-btn" onclick="startQuiz('ãƒ†ã‚¯ãƒãƒ­ã‚¸')">ãƒ†ã‚¯ãƒãƒ­ã‚¸ç³»</button>
            <button class="tag-btn" onclick="startQuiz('ALL')">å…¨åˆ†é‡ãƒ©ãƒ³ãƒ€ãƒ </button>
            <button class="tag-btn" style="border-style: dashed; margin-top: 1rem;" onclick="startVocabMode()">ğŸ“š å˜èªå¸³ãƒ¢ãƒ¼ãƒ‰</button>
        </div>
    </div>

    <div id="quiz" class="screen">
        <div class="meta"><span id="q-meta"></span></div>
        <div id="question"></div>
        <ul id="options" class="options-list"></ul>
    </div>

    <div id="vocab" class="screen">
        <div class="meta">å˜èªå¸³ãƒ¢ãƒ¼ãƒ‰</div>
        <div id="v-name"></div>
        <div id="v-def-box" style="display:none; background:#f0f0f0; padding:1.2rem; border-radius:6px; margin-bottom:1rem; text-align:center; font-size:0.95rem;"></div>
        <button id="v-show-btn" class="tag-btn" onclick="showVocabDef()">æ„å‘³ã‚’ç¢ºèª</button>
        <div id="v-controls" style="display:none; gap:10px;">
            <button class="tag-btn" style="flex:1; background:#e8f5e9; border-color:#2e7d32; color:#2e7d32;" onclick="handleVocabResult(true)">è¦šãˆãŸ</button>
            <button class="tag-btn" style="flex:1; background:#ffebee; border-color:#d32f2f; color:#d32f2f;" onclick="handleVocabResult(false)">ã¾ã </button>
        </div>
    </div>
</div>

<div id="overlay">
    <div id="modal">
        <div id="modal-message"></div>
        <div id="modal-explanation"></div>
        <button id="modalNextBtn">æ¬¡ã¸ â–¶</button>
    </div>
</div>

<div class="footer-tools"><button class="reset-link" onclick="fullReset()">åˆæœŸåŒ–</button></div>

<script>
let allData = { questions: [], terms: {} };
let currentSet = [];
let vocabQueue = [];
let currentIdx = 0;
let mode = 'quiz'; // 'quiz' or 'vocab'

// æ°¸ç¶šãƒ‡ãƒ¼ã‚¿
let learningList = new Set(JSON.parse(localStorage.getItem('itp_learn_list')) || []);
let qCounts = JSON.parse(localStorage.getItem('itp_q_counts')) || {};
let vCounts = JSON.parse(localStorage.getItem('itp_v_counts')) || {};

async function init() {
    try {
        const [resQ, resT] = await Promise.all([fetch('questions.json'), fetch('terms.json')]);
        allData.questions = await resQ.json();
        allData.terms = await resT.json();
    } catch (e) { console.error("Data load failed."); }
}

function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if(id === 'home') document.getElementById('mainTitle').style.display = 'block';
    else document.getElementById('mainTitle').style.display = 'none';
}

// 10å•é¸å‡ºãƒ­ã‚¸ãƒƒã‚¯ (1-7:count0, 8-9:count1, 10:count2)
function startQuiz(cat) {
    mode = 'quiz'; currentSet = []; vocabQueue = [];
    const filterByCount = (c, n) => allData.questions.filter(q => (c === 'ALL' || q.category === c) && (qCounts[q.id] || 0) === n);
    const filterAnyByCount = (n) => allData.questions.filter(q => (qCounts[q.id] || 0) === n);

    const pick = (target, needed, n) => {
        let pool = filterByCount(cat, n).filter(x => !target.includes(x));
        if (pool.length < needed) pool = [...pool, ...filterAnyByCount(n).filter(x => !target.includes(x) && !pool.includes(x))];
        return pool.sort(() => Math.random() - 0.5).slice(0, needed);
    };

    currentSet.push(...pick([], 7, 0));
    currentSet.push(...pick(currentSet, 2, 1));
    currentSet.push(...pick(currentSet, 1, 2));

    // 10å•ã«æº€ãŸãªã„å ´åˆã®è£œå……
    if (currentSet.length < 10) {
        let others = allData.questions.filter(q => !currentSet.includes(q) && (qCounts[q.id] || 0) < 3).sort(() => Math.random() - 0.5);
        currentSet.push(...others.slice(0, 10 - currentSet.length));
    }

    currentIdx = 0; showScreen('quiz'); renderQuiz();
}

function renderQuiz() {
    const q = currentSet[currentIdx];
    document.getElementById('q-meta').innerText = `${q.category} | ${q.id} (${currentIdx + 1}/10)`;
    document.getElementById('question').innerHTML = q.question;
    const ul = document.getElementById('options'); ul.innerHTML = '';
    q.options.forEach((opt, i) => {
        const li = document.createElement('li');
        const btn = document.createElement('button');
        btn.innerText = opt;
        btn.onclick = () => checkAnswer(i);
        li.appendChild(btn);
        ul.appendChild(li);
    });
}

function checkAnswer(idx) {
    const q = currentSet[currentIdx];
    const isCorrect = (idx === q.answer);
    
    // UIæ›´æ–° (ãƒœã‚¿ãƒ³ã®è‰²ä»˜ã‘)
    const btns = document.querySelectorAll('#options button');
    btns.forEach((b, i) => {
        b.disabled = true;
        if(i === q.answer) b.style.background = '#e8f5e9';
        if(i === idx && !isCorrect) b.style.background = '#ffebee';
    });

    // ãƒ­ã‚¸ãƒƒã‚¯é©ç”¨
    if (isCorrect) {
        qCounts[q.id] = (qCounts[q.id] || 0) + 1;
        showModal(true, "", q.explanation);
    } else {
        qCounts[q.id] = 0;
        q.term_ids.forEach(tid => {
            vCounts[tid] = 0; // è¿½åŠ æ™‚ã«ãƒªã‚»ãƒƒãƒˆ
            learningList.add(tid);
            if(!vocabQueue.includes(tid)) vocabQueue.push(tid);
        });
        showModal(false, q.options[q.answer], q.explanation);
    }
    save();
}

function showModal(isCorrect, correctText, explanation) {
    const msg = document.getElementById('modal-message');
    if (isCorrect) {
        msg.innerHTML = '<span style="color:#2e7d32; font-weight:bold;">ğŸŸ¢ æ­£è§£ï¼</span>';
    } else {
        msg.innerHTML = `<span style="color:#d32f2f; font-weight:bold;">âŒ ä¸æ­£è§£</span><br><span style="font-size:0.9rem; color:#666;">æ­£è§£: ${correctText}</span>`;
    }
    document.getElementById('modal-explanation').innerText = "è§£èª¬: " + explanation;
    document.getElementById('overlay').style.display = 'flex';
}

document.getElementById('modalNextBtn').onclick = () => {
    document.getElementById('overlay').style.display = 'none';
    currentIdx++;
    if (currentIdx < currentSet.length) {
        renderQuiz();
    } else {
        // ã‚¯ã‚¤ã‚ºçµ‚äº†å¾Œã€é–“é•ãˆãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒã‚ã‚Œã°ãƒ‰ãƒªãƒ«ã¸
        if (vocabQueue.length > 0) startVocabSession(vocabQueue);
        else location.reload();
    }
};

// å˜èªå¸³ãƒ¢ãƒ¼ãƒ‰
function startVocabMode() {
    let list = Array.from(learningList);
    if (list.length === 0) return alert("è¦šãˆã‚‹ãƒªã‚¹ãƒˆã¯ç©ºã§ã™ã€‚");
    
    vocabQueue = [];
    const getTs = (n) => list.filter(tid => (vCounts[tid] || 0) === n);
    const fillV = (target, needed, n) => getTs(n).filter(x => !target.includes(x)).sort(() => Math.random() - 0.5).slice(0, needed);

    vocabQueue.push(...fillV([], 7, 0));
    vocabQueue.push(...fillV(vocabQueue, 2, 1));
    vocabQueue.push(...fillV(vocabQueue, 1, 2));

    if (vocabQueue.length < 10 && list.length > vocabQueue.length) {
        let others = list.filter(tid => !vocabQueue.includes(tid)).sort(() => Math.random() - 0.5);
        vocabQueue.push(...others.slice(0, 10 - vocabQueue.length));
    }
    startVocabSession(vocabQueue);
}

function startVocabSession(q) {
    mode = 'vocab'; vocabQueue = q; currentIdx = 0;
    showScreen('vocab'); renderVocab();
}

function renderVocab() {
    const tid = vocabQueue[currentIdx];
    document.getElementById('v-name').innerText = allData.terms[tid].name;
    document.getElementById('v-def-box').innerText = allData.terms[tid].def;
    document.getElementById('v-def-box').style.display = 'none';
    document.getElementById('v-show-btn').style.display = 'block';
    document.getElementById('v-controls').style.display = 'none';
}

function showVocabDef() {
    document.getElementById('v-def-box').style.display = 'block';
    document.getElementById('v-show-btn').style.display = 'none';
    document.getElementById('v-controls').style.display = 'flex';
}

function handleVocabResult(known) {
    const tid = vocabQueue[currentIdx];
    if (known) {
        vCounts[tid] = (vCounts[tid] || 0) + 1;
        if (vCounts[tid] >= 3) learningList.delete(tid);
        currentIdx++;
    } else {
        const moved = vocabQueue.splice(currentIdx, 1)[0];
        vocabQueue.push(moved); // ãƒªã‚»ãƒƒãƒˆã›ãšæœ€å¾Œå°¾ã¸
    }
    save();
    if (currentIdx < vocabQueue.length) renderVocab();
    else { alert("ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†"); location.reload(); }
}

function save() {
    localStorage.setItem('itp_learn_list', JSON.stringify(Array.from(learningList)));
    localStorage.setItem('itp_q_counts', JSON.stringify(qCounts));
    localStorage.setItem('itp_v_counts', JSON.stringify(vCounts));
}

function fullReset() { if(confirm('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) { localStorage.clear(); location.reload(); } }

init();
</script>
</body>
</html>
