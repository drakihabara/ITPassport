<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ITパスポート クイズ</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", "Yu Gothic", sans-serif; margin: 20px; background: #fff; color: #111; }
    h2 { margin-top: 0; }
    .question { font-size: 18px; margin-bottom: 16px; }
    .option { display: block; width: 100%; margin: 8px 0; padding: 12px; font-size: 16px;
              border: 1px solid #ccc; border-radius: 8px; background: #f9f9f9; text-align: left; cursor: pointer; }
    .option:hover { background: #f1f5f9; }
    .option.correct { background: #d1fae5; border-color: #10b981; }
    .option.wrong { background: #fee2e2; border-color: #ef4444; }
    #feedback { margin-top: 12px; font-weight: bold; }
    #explanation { margin-top: 8px; font-size: 14px; color: #333; }
    #start button { margin-right: 8px; margin-bottom: 8px; padding: 10px 14px; border-radius: 8px; border: 1px solid #ccc; background: #f9f9f9; cursor: pointer; }
    #start button:disabled { opacity: 0.6; cursor: not-allowed; }
    #note { color:#555; font-size: 13px; margin-top:6px; }
  </style>
</head>
<body>
  <div id="start">
    <h2>分野を選んでください</h2>
    <p id="loading">読み込み中…</p>
    <button onclick="startQuiz('ストラテジ')" disabled>ストラテジ</button>
    <button onclick="startQuiz('マネジメント')" disabled>マネジメント</button>
    <button onclick="startQuiz('テクノロジ')" disabled>テクノロジ</button>
    <button onclick="startQuiz('all')" disabled>全分野</button>
    <div id="note">CSVはUTF-8、末尾の空行なし、tagsは「ストラテジ／マネジメント／テクノロジ」で統一してください。</div>
  </div>

  <div id="quiz" style="display:none;">
    <div id="qText" class="question"></div>
    <div id="options"></div>
    <div id="feedback"></div>
    <div id="explanation"></div>
  </div>

  <script>
  // 設定
  const NUM_QUESTIONS_PER_RUN = 30; // 1回の出題数（分野ごと）

  // 状態
  let allQuestions = [];
  let questions = [];
  let idx = 0;
  let score = 0;

  // 起動時にCSVをロード
  loadCSV();

  // CSVロード＆パース
  async function loadCSV() {
    toggleStartButtons(false);
    const loadingP = document.getElementById('loading');
    try {
      // キャッシュ無効化＋BOM対応
      const res = await fetch('questions.csv?v=' + Date.now(), { cache: 'no-store' });
      if (!res.ok) throw new Error('questions.csv を取得できませんでした');
      const raw = (await res.text()).replace(/^\uFEFF/, '');

      // 行へ分割（CRLF/LF対応）、空行除外
      const lines = raw.split(/\r?\n/).filter(line => line.trim() !== '');
      const rows = parseCSV(lines);
      if (!rows || rows.length < 2) throw new Error('CSVにデータ行がありません');

      const header = rows[0];
      const body = rows.slice(1);

      // 列不足行を除外してマッピング（全項目trim）
      allQuestions = body
        .filter(cols => cols && cols.length >= 9)
        .map(cols => {
          const q = (cols[1] || '').trim();
          const o1 = (cols[2] || '').trim();
          const o2 = (cols[3] || '').trim();
          const o3 = (cols[4] || '').trim();
          const o4 = (cols[5] || '').trim();
          const ans = parseInt((cols[6] || '').trim(), 10) - 1;
          const exp = (cols[7] || '').trim();
          const tag = (cols[8] || '').trim();
          return {
            q,
            options: [o1, o2, o3, o4],
            answer: isFinite(ans) ? ans : -1,
            explanation: exp,
            tag
          };
        })
        .filter(x =>
          x.q &&
          Array.isArray(x.options) && x.options.length === 4 && x.options.every(v => typeof v === 'string') &&
          Number.isInteger(x.answer) && x.answer >= 0 && x.answer < 4 &&
          x.tag
        );

      // ログ（確認用）
      console.log('総数:', allQuestions.length);
      console.log('ストラテジ:', allQuestions.filter(q => q.tag === 'ストラテジ').length);
      console.log('マネジメント:', allQuestions.filter(q => q.tag === 'マネジメント').length);
      console.log('テクノロジ:', allQuestions.filter(q => q.tag === 'テクノロジ').length);

      loadingP.textContent = '読み込み完了';
      toggleStartButtons(true);
      setTimeout(()=>{ loadingP.remove(); }, 500);
    } catch (e) {
      console.error(e);
      loadingP.textContent = '読み込みに失敗しました。CSVの配置や形式を確認してください。';
    }
  }

  // 分野開始
  function startQuiz(tag) {
    // フィルタ前に見える化
    console.log('[startQuiz] tag=', tag);

    let pool = (tag === 'all') ? allQuestions : allQuestions.filter(q => q.tag === tag);
    console.log('[startQuiz] pool length =', pool.length);

    // シャッフル
    pool = shuffle(pool);

    // 30問 or ある分だけ
    const n = Math.min(NUM_QUESTIONS_PER_RUN, pool.length);
    questions = pool.slice(0, n);

    // 空配列ガード
    if (questions.length === 0) {
      alert('この分野の問題がありません。CSVの tags と分野ボタンの表記が一致しているか確認してください。\n（ストラテジ／マネジメント／テクノロジ）');
      location.reload();
      return;
    }

    idx = 0;
    score = 0;

    // UI切り替えは最後に
    document.getElementById('start').style.display = 'none';
    document.getElementById('quiz').style.display = 'block';

    showQuestion();
  }

  // 問題表示（境界＆構造ガード付き）
  function showQuestion() {
    if (idx < 0 || idx >= questions.length) {
      console.warn('[showQuestion] idx out of range:', idx, 'len=', questions.length);
      showResult();
      return;
    }
    const q = questions[idx];

    // 構造チェック
    if (!q || typeof q.q !== 'string' || !Array.isArray(q.options) || q.options.length !== 4) {
      console.error('[showQuestion] invalid question at idx', idx, q);
      showResult();
      return;
    }

    document.getElementById('qText').textContent = `Q${idx + 1}. ${q.q}`;
    const optDiv = document.getElementById('options');
    optDiv.innerHTML = '';
    q.options.forEach((opt, i) => {
      const btn = document.createElement('button');
      btn.textContent = opt;
      btn.className = 'option';
      btn.onclick = () => checkAnswer(i);
      optDiv.appendChild(btn);
    });
    document.getElementById('feedback').textContent = '';
    document.getElementById('explanation').textContent = '';
  }

  // 回答チェック
  function checkAnswer(i) {
    const q = questions[idx];
    const opts = document.querySelectorAll('.option');
    opts.forEach((b, j) => {
      if (j === q.answer) b.classList.add('correct');
      if (j === i && i !== q.answer) b.classList.add('wrong');
      b.disabled = true;
    });

    if (i === q.answer) {
      document.getElementById('feedback').textContent = '✅ 正解！';
      score++;
    } else {
      document.getElementById('feedback').textContent = '❌ 不正解…';
    }
    document.getElementById('explanation').textContent = `解説: ${q.explanation}`;

    setTimeout(() => {
      idx++;
      if (idx < questions.length) {
        showQuestion();
      } else {
        showResult();
      }
    }, 1200);
  }

  // 結果表示
  function showResult() {
    const total = questions.length;
    const rate = total ? Math.round((score / total) * 100) : 0;
    document.getElementById('quiz').innerHTML = `
      <h2>結果</h2>
      <p>正解数: ${score} / ${total}（正答率 ${rate}%）</p>
      <button onclick="location.reload()">もう一度</button>
    `;
  }

  // ボタンの有効/無効
  function toggleStartButtons(enabled) {
    document.querySelectorAll('#start button').forEach(b => b.disabled = !enabled);
  }

  // Fisher-Yates シャッフル
  function shuffle(array) {
    const a = array.slice();
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  // クォートとカンマに強い簡易CSVパーサ（1行=1レコード前提）
  function parseCSV(lines) {
    const rows = [];
    for (const line of lines) {
      const row = [];
      let cur = '';
      let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const c = line[i];
        if (inQuotes) {
          if (c === '"') {
            if (i + 1 < line.length && line[i + 1] === '"') {
              cur += '"'; i++; // 連続2つはエスケープされたダブルクォート
            } else {
              inQuotes = false;
            }
          } else {
            cur += c;
          }
        } else {
          if (c === '"') {
            inQuotes = true;
          } else if (c === ',') {
            row.push(cur);
            cur = '';
          } else {
            cur += c;
          }
        }
      }
      row.push(cur);
      rows.push(row);
    }
    return rows;
  }
  </script>
</body>
</html>
