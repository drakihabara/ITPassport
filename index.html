<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ITãƒ‘ã‚¹ãƒãƒ¼ãƒˆ</title>
    <style>
        :root { --main: #1a1a1a; --border: #333; --light: #f5f5f5; --red: #d32f2f; --green: #2e7d32; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, sans-serif; margin: 0; padding: 20px; color: var(--main); background: #fff; line-height: 1.6; }
        .container { max-width: 600px; margin: 0 auto; padding-bottom: 120px; }
        header { border-bottom: 2px solid var(--main); margin-bottom: 20px; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: baseline; }
        h1 { margin: 0; font-size: 1.5rem; letter-spacing: 0.1rem; cursor: pointer; }
        .screen { display: none; } .active { display: block; }
        .btn { padding: 20px; border: 1px solid var(--border); background: #fff; cursor: pointer; font-size: 1.1rem; text-align: left; width: 100%; border-radius: 4px; margin-bottom: 10px; }
        .btn:hover { background: var(--light); }
        .meta { color: #666; font-size: 0.8rem; margin-bottom: 5px; }
        .q-text { font-size: 1.2rem; font-weight: bold; margin-bottom: 20px; }
        .options { display: flex; flex-direction: column; gap: 10px; }
        .opt-btn { text-align: left; padding: 18px; border: 1px solid var(--border); background: #fff; cursor: pointer; font-size: 1rem; border-radius: 4px; }
        .opt-btn:disabled { opacity: 0.5; }
        .still-btn { margin-top: 30px; padding: 15px; background: none; border: 1px solid #999; color: #666; width: 100%; cursor: pointer; font-size: 0.9rem; }
        #feedback { margin-top: 25px; padding: 20px; border: 2px solid var(--main); display: none; }
        .action-btn { margin-top: 20px; width: 100%; padding: 18px; background: var(--main); color: #fff; border: none; cursor: pointer; font-size: 1.1rem; }
        .footer-tools { position: fixed; right: 20px; bottom: 60px; z-index: 100; }
        .reset-link { font-size: 0.7rem; color: #bbb; border: none; background: none; text-decoration: underline; cursor: pointer; }
        .badge { font-size: 0.7rem; background: #eee; padding: 2px 6px; border-radius: 10px; margin-left: 5px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1 onclick="location.reload()">ITãƒ‘ã‚¹ãƒãƒ¼ãƒˆ</h1>
        <div style="font-size:0.9rem;">ç¿’å¾—: <span id="master-count">0</span></div>
    </header>

    <div id="home" class="screen active">
        <div class="menu">
            <button class="btn" onclick="startQuiz('ã‚¹ãƒˆãƒ©ãƒ†ã‚¸')">ã‚¹ãƒˆãƒ©ãƒ†ã‚¸ç³»</button>
            <button class="btn" onclick="startQuiz('ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆ')">ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆç³»</button>
            <button class="btn" onclick="startQuiz('ãƒ†ã‚¯ãƒãƒ­ã‚¸')">ãƒ†ã‚¯ãƒãƒ­ã‚¸ç³»</button>
            <button class="btn" onclick="startQuiz('ALL')">å…¨åˆ†é‡ãƒ©ãƒ³ãƒ€ãƒ </button>
            <button class="btn" style="border-style:dashed; margin-top:20px;" onclick="startVocabMode()">ğŸ“š å˜èªå¸³ãƒ¢ãƒ¼ãƒ‰</button>
        </div>
    </div>

    <div id="quiz" class="screen">
        <div class="meta"><span id="q-cat"></span> | <span id="q-id"></span> <span id="q-count-ui" class="badge"></span></div>
        <div id="q-text" class="q-text"></div>
        <div id="options" class="options"></div>
        <button id="q-still" class="still-btn" onclick="handleStill()">ã¾ã  (è‡ªä¿¡ãªã—ï¼š0ã«ãƒªã‚»ãƒƒãƒˆ)</button>
        <div id="feedback">
            <div id="res-msg" style="font-weight:bold; margin-bottom:10px;"></div>
            <div id="explanation" style="font-size:0.9rem;"></div>
            <button class="action-btn" onclick="nextStep()">æ¬¡ã¸</button>
        </div>
    </div>

    <div id="vocab" class="screen">
        <div class="meta">å˜èªå¸³ãƒ¢ãƒ¼ãƒ‰ <span id="v-count-ui" class="badge"></span></div>
        <div id="v-name" style="font-size: 1.8rem; font-weight:bold; margin: 40px 0 20px; text-align:center;"></div>
        <div id="v-def" style="display:none; padding: 20px; border: 1px solid #eee; margin-bottom:30px; text-align:center;"></div>
        <button id="v-show-def" class="action-btn" onclick="showDef()">æ„å‘³ã‚’ç¢ºèª</button>
        <div id="v-controls" style="display:none; gap:10px;">
            <button class="action-btn" style="background:var(--green); flex:1;" onclick="handleVocabResult(true)">è¦šãˆãŸ</button>
            <button class="action-btn" style="background:var(--red); flex:1;" onclick="handleVocabResult(false)">ã¾ã </button>
        </div>
    </div>
</div>

<div class="footer-tools"><button class="reset-link" onclick="fullReset()">åˆæœŸåŒ–</button></div>

<script>
let allData = { questions: [], terms: {} };
let quizSet = [];
let vocabQueue = [];
let currentIdx = 0;
let learningList = new Set(JSON.parse(localStorage.getItem('itp_learning_list')) || []); 
let qCounts = JSON.parse(localStorage.getItem('itp_q_counts')) || {};
let vCounts = JSON.parse(localStorage.getItem('itp_v_counts')) || {}; 

async function init() {
    try {
        const [resQ, resT] = await Promise.all([fetch('questions.json'), fetch('terms.json')]);
        allData.questions = await resQ.json();
        allData.terms = await resT.json();
        updateMasterCount();
    } catch (e) { alert("ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—"); }
}

function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

function startQuiz(cat) {
    quizSet = [];
    const getQs = (c, count) => allData.questions.filter(q => (c === 'ALL' || q.category === c) && (qCounts[q.id] || 0) === count);
    const getAllQs = (count) => allData.questions.filter(q => (qCounts[q.id] || 0) === count);

    const fill = (target, needed, count) => {
        let pool = getQs(cat, count).filter(x => !target.includes(x));
        if (pool.length < needed) pool = [...pool, ...getAllQs(count).filter(x => !target.includes(x) && !pool.includes(x))];
        return pool.sort(() => Math.random() - 0.5).slice(0, needed);
    };

    quizSet.push(...fill([], 7, 0));
    quizSet.push(...fill(quizSet, 2, 1));
    quizSet.push(...fill(quizSet, 1, 2));

    if (quizSet.length < 10) {
        let others = allData.questions.filter(q => !quizSet.includes(q) && (qCounts[q.id] || 0) < 3).sort(() => Math.random() - 0.5);
        quizSet.push(...others.slice(0, 10 - quizSet.length));
    }

    currentIdx = 0;
    vocabQueue = [];
    showScreen('quiz');
    renderQuiz();
}

function renderQuiz() {
    const q = quizSet[currentIdx];
    document.getElementById('q-cat').innerText = q.category;
    document.getElementById('q-id').innerText = q.id;
    document.getElementById('q-text').innerText = q.question;
    document.getElementById('q-count-ui').innerText = (qCounts[q.id] || 0) + "å›";
    document.getElementById('feedback').style.display = 'none';
    const container = document.getElementById('options');
    container.innerHTML = '';
    q.options.forEach((opt, i) => {
        const b = document.createElement('button');
        b.className = 'opt-btn';
        b.innerText = opt;
        b.onclick = () => checkQuiz(i);
        container.appendChild(b);
    });
    document.getElementById('q-still').style.display = 'block';
}

function checkQuiz(idx) {
    const q = quizSet[currentIdx];
    const isCorrect = (idx === q.answer);
    handleResult(q, isCorrect);
}

function handleStill() { handleResult(quizSet[currentIdx], false); }

function handleResult(q, isCorrect) {
    const msg = document.getElementById('res-msg');
    if (isCorrect) {
        msg.innerText = "â­• æ­£è§£";
        msg.style.color = "var(--green)";
        qCounts[q.id] = (qCounts[q.id] || 0) + 1;
    } else {
        msg.innerText = "âŒ ãƒªã‚»ãƒƒãƒˆ";
        msg.style.color = "var(--red)";
        qCounts[q.id] = 0;
        q.term_ids.forEach(tid => { 
            vCounts[tid] = 0; 
            learningList.add(tid); 
            if(!vocabQueue.includes(tid)) vocabQueue.push(tid);
        });
    }
    document.getElementById('explanation').innerText = q.explanation;
    document.getElementById('feedback').style.display = 'block';
    document.getElementById('q-still').style.display = 'none';
    document.querySelectorAll('.opt-btn').forEach(b => b.disabled = true);
    save();
}

function nextStep() {
    currentIdx++;
    if (currentIdx < 10 && currentIdx < quizSet.length) {
        renderQuiz();
    } else {
        if (vocabQueue.length > 0) startVocabSession(vocabQueue);
        else location.reload();
    }
}

function startVocabMode() {
    let list = Array.from(learningList);
    if (list.length === 0) return alert("è¦šãˆã‚‹ãƒªã‚¹ãƒˆã¯ç©ºã§ã™ã€‚");
    vocabQueue = [];
    const getTs = (c) => list.filter(tid => (vCounts[tid] || 0) === c);
    const fillV = (target, needed, c) => getTs(c).filter(x => !target.includes(x)).sort(() => Math.random() - 0.5).slice(0, needed);

    vocabQueue.push(...fillV([], 7, 0));
    vocabQueue.push(...fillV(vocabQueue, 2, 1));
    vocabQueue.push(...fillV(vocabQueue, 1, 2));

    if (vocabQueue.length < 10 && list.length > vocabQueue.length) {
        let others = list.filter(tid => !vocabQueue.includes(tid)).sort(() => Math.random() - 0.5);
        vocabQueue.push(...others.slice(0, 10 - vocabQueue.length));
    }
    startVocabSession(vocabQueue);
}

function startVocabSession(q) {
    vocabQueue = q; currentIdx = 0;
    showScreen('vocab'); renderVocab();
}

function renderVocab() {
    const tid = vocabQueue[currentIdx];
    const t = allData.terms[tid];
    document.getElementById('v-name').innerText = t.name;
    document.getElementById('v-def').innerText = t.def;
    document.getElementById('v-def').style.display = 'none';
    document.getElementById('v-show-def').style.display = 'block';
    document.getElementById('v-controls').style.display = 'none';
    document.getElementById('v-count-ui').innerText = (vCounts[tid] || 0) + "å›";
}

function showDef() {
    document.getElementById('v-def').style.display = 'block';
    document.getElementById('v-show-def').style.display = 'none';
    document.getElementById('v-controls').style.display = 'flex';
}

function handleVocabResult(known) {
    const tid = vocabQueue[currentIdx];
    if (known) {
        vCounts[tid] = (vCounts[tid] || 0) + 1;
        if (vCounts[tid] >= 3) learningList.delete(tid);
        currentIdx++;
    } else {
        vCounts[tid] = 0;
        const moved = vocabQueue.splice(currentIdx, 1)[0];
        vocabQueue.push(moved);
    }
    save();
    if (currentIdx < vocabQueue.length) renderVocab();
    else { alert("ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†"); location.reload(); }
}

function save() {
    localStorage.setItem('itp_learning_list', JSON.stringify(Array.from(learningList)));
    localStorage.setItem('itp_q_counts', JSON.stringify(qCounts));
    localStorage.setItem('itp_v_counts', JSON.stringify(vCounts));
    updateMasterCount();
}

function updateMasterCount() {
    let count = Object.keys(allData.terms).filter(tid => !learningList.has(tid) && vCounts[tid] >= 0).length;
    // â€» ç°¡ç•¥åŒ–ã®ãŸã‚ã€ä¸€åº¦ã§ã‚‚å˜èªå¸³ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«å‡ºãŸã“ã¨ã®ã‚ã‚‹ã‚‚ã®ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
    document.getElementById('master-count').innerText = count;
}

function fullReset() { if(confirm('åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ')) { localStorage.clear(); location.reload(); } }

init();
</script>
</body>
</html>
